<html>
<head>
<title>Travelling Salesman Problem Sample</title>
<script src="../../lib/simplega.js" language="javascript"></script>
</head>
<body>
<h1>Travelling Salesman Problem Sample</h1>

<input type="button" value="Relaunch" onclick="relaunch()">

<canvas id="canvas" width="500" height="400">
</canvas>

<script language="javascript">

// http://www.merlyn.demon.co.uk/js-shufl.htm#FnB

function shuffle(values)
{
	var l = values.length;
	
	for (var k = l, j; k-- > 0; )
	{
		var value = values[k];
		j = Math.floor(Math.random() * l);
		values[k] = values[j];
		values[j] = value;
	}
	
	return values;
}

function getPoints(m, n)
{
    var points = [];
    
    for (var k = 0; k < m; k++)
        for (var j = 0; j < n; j++)
            points.push({ x: k, y: j });
            
    return points;
}

function getValues(n)
{
    var values = new Array(n);
    
    for (var k = 0; k < n; k++)
        values[k] = k;
    
    return values;
}

function Genotype(points, maxlength, values)
{
    var n = points.length;
    var value = 0;
    
    if (!values) {
        values = getValues(n);
        shuffle(values);
    }
    
    this.evaluate = function() {
        if (value)
            return value;
            
        value = maxlength;
        
        var x = points[values[0]].x;
        var y = points[values[0]].y;
        
        for (var k = 1; k < n; k++)
        {
            var x2 = points[values[k]].x;
            var y2 = points[values[k]].y;
            
            value -= (x-x2) * (x-x2) + (y-y2)*(y-y2);
            
            x = x2;
            y = y2;
        }
        
        return value;
    }
    
    this.getValues = function() { return values; }
    
    this.clone = function(newvalues) {
        return new Genotype(points, maxlength, newvalues);
    }
}

function Mutator() {
    this.mutate = function(genotype) {
        if (Math.random() >= 0.5)
            return genotype;
            
        var values = genotype.getValues().slice(0);
        var l = values.length;
        
        var pos1 = Math.floor(Math.random() * l);
        var pos2 = (pos1 + 1) % l;
        
/*        if (Math.random() >= 0.8)
            pos2 = Math.floor(Math.random() * l);*/
        
        var value = values[pos1];
        values[pos1] = values[pos2];
        values[pos2] = value;
        
        return genotype.clone(values);
    }
}


</script>

<script language="javascript">
var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");

function drawPoints()
{
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.beginPath();
    for (var k = 0; k < 4; k++)
        for (var j = 0; j < 3; j++) {
            context.arc(50 + 100 * k, 50 + 100 * j, 10, 0, Math.PI * 2, true);
        }
    context.closePath();
    context.fill();
}

function drawValues(points, values)
{
    context.beginPath();
    
    var l = values.length;
    var point = points[values[0]];
    
    context.moveTo(50 + 100 * point.x, 50 + 100 * point.y);
    
    for (var k = 1; k < l; k++) {
        point = points[values[k]];
        context.lineTo(50 + 100 * point.x, 50 + 100 * point.y);
    }
    
    context.closePath();
    context.stroke();
}

var points = getPoints(4, 3);
var maxlength = 3 * 4 * (3*3 + 4*4);

var genotype = new Genotype(points, maxlength);

drawPoints();
drawValues(points, genotype.getValues());

var engine = new simplega.Engine();

var population = [];

for (var k = 1; k < 5000; k++)
    population.push(new Genotype(points, maxlength));

engine.setMutators([new Mutator()]);

var bestvalue = 0;
var bestpath;

setTimeout(doStep, 100);

function doStep() {
    engine.setPopulation(population);
    population = engine.nextPopulation();
    var newbestvalue = simplega.getBestValue(population);
    
    if (newbestvalue >= bestvalue) {
        bestvalue = newbestvalue;
        var l = population.length;
        for (var k = 0; k < l; k++)
            if (population[k].evaluate() == newbestvalue) {
                drawPoints();
                drawValues(points, population[k].getValues());
            }
    }
    
    setTimeout(doStep, 100);
}


function relaunch() {
    var newpopulation = [];

    for (var k = 1; k < 5000; k++)
        newpopulation.push(new Genotype(points, maxlength));
        
    bestvalue = 0;
    population = newpopulation;
}

</script>
</body>
</html>